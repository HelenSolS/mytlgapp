<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SigilCraft Elite</title>

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #050505;
            color: #e5e5e5;
            margin: 0;
            overflow: hidden;
        }
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: #1a1a1a;
            padding: 32px;
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        .modal input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            margin-top: 16px;
        }
        .modal button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 16px;
            cursor: pointer;
        }
        .modal button:hover {
            opacity: 0.9;
        }
    </style>

    <!-- Import Maps -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ -->
    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            if (tg.themeParams?.bg_color) {
                document.body.style.backgroundColor = tg.themeParams.bg_color;
            }
            console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        window.AppMode = {
            SIGIL: '–°–∏–≥–∏–ª—ã',
            ASSOCIATION: '–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏'
        };

        window.RenderingStyle = {
            CARTOON: '–ö–∞—Ä–∏–∫–∞—Ç—É—Ä–Ω—ã–π/–ú—É–ª—å—Ç—è—à–Ω—ã–π',
            COMIC: '–ö–æ–º–∏–∫—Å (Retro/Marvel)',
            PENCIL: '–ö–∞—Ä–∞–Ω–¥–∞—à–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫',
            INK: '–ß–µ—Ä–Ω–æ-–±–µ–ª–∞—è —Ç—É—à—å',
            SKETCH: '–ñ–∏–≤–æ–π —ç—Å–∫–∏–∑',
            KAWAII: '–ú–∏–ª—ã–π (Kawaii)',
            HYPERREALISM: '–ì–∏–ø–µ—Ä—Ä–µ–∞–ª–∏–∑–º',
            SCHEMATIC: '–°—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π/–ß–µ—Ä—Ç–µ–∂',
            CONVEX_3D: '–í—ã–ø—É–∫–ª—ã–π 3D —Ä–µ–ª—å–µ—Ñ',
            REALISM: '–§–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º'
        };

        window.MagicVibe = {
            GLOWING: '–ú–∞–≥–∏—á–µ—Å–∫–æ–µ —Å–∏—è–Ω–∏–µ',
            MYSTERIOUS: '–ó–∞–≥–∞–¥–æ—á–Ω—ã–π —à–µ–ø–æ—Ç',
            ETHEREAL: '–≠—Ñ–∏—Ä–Ω–∞—è –ø—ã–ª—å'
        };

        window.SymbolPosition = {
            CENTER: '–¶–µ–Ω—Ç—Ä',
            TOP: '–í–µ—Ä—Ö',
            BOTTOM: '–ù–∏–∑'
        };

        window.SIGIL_DATABASE = [
            { id: 1, name: "The Whisper", nameRu: "–®—ë–ø–æ—Ç", element: '–í–æ–∑–¥—É—Ö', visualTz: "Thin curved line, gently splitting into two branches", baseColor: "#87CEEB" },
            { id: 2, name: "Gate of Winds", nameRu: "–í—Ä–∞—Ç–∞ –í–µ—Ç—Ä–æ–≤", element: '–í–æ–∑–¥—É—Ö', visualTz: "Two parallel vertical lines, between them a vortex shift", baseColor: "#87CEEB" },
            { id: 12, name: "The Ripple", nameRu: "–†—è–±—å", element: '–í–æ–¥–∞', visualTz: "Concentric circles, radiating from a point", baseColor: "#00CED1" },
            { id: 23, name: "The Spark", nameRu: "–ò—Å–∫—Ä–∞", element: '–û–≥–æ–Ω—å', visualTz: "Small flash: short line + splitting", baseColor: "#FF8C00" },
            { id: 34, name: "Rootmark", nameRu: "–ö–æ—Ä–µ–Ω—å", element: '–ó–µ–º–ª—è', visualTz: "Y-shaped or root-like line", baseColor: "#808000" },
            { id: 45, name: "Thread of Fate", nameRu: "–ù–∏—Ç—å –°—É–¥—å–±—ã", element: '–≠—Ñ–∏—Ä', visualTz: "One vertical line - straight, inevitable", baseColor: "#FFD700" },
            { id: 66, name: "Catalyst", nameRu: "–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä", element: '–ü–ª–µ—Ç–µ–Ω–∏–µ', visualTz: "Central point + diverging short rays", baseColor: "#FFD700" }
        ];

        window.getApiKey = () => localStorage.getItem('gemini_api_key');
        window.setApiKey = (key) => localStorage.setItem('gemini_api_key', key);

        console.log('‚úÖ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    </script>

    <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <script type="module">
        import React, { useState } from 'react';
        import ReactDOM from 'react-dom/client';

        const { AppMode, RenderingStyle, MagicVibe, SymbolPosition, SIGIL_DATABASE } = window;

        // –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ú–û–î–ï–õ–¨!)
        const generateCardImage = async (config, apiKey) => {
            const getStyleDescription = (style) => {
                const styles = {
                    [RenderingStyle.CARTOON]: "Bold, stylized illustration",
                    [RenderingStyle.COMIC]: "Comic book style with halftones",
                    [RenderingStyle.PENCIL]: "Pencil drawing",
                    [RenderingStyle.INK]: "Black ink wash",
                    [RenderingStyle.SKETCH]: "Charcoal sketch",
                    [RenderingStyle.KAWAII]: "Cute kawaii style",
                    [RenderingStyle.HYPERREALISM]: "Photorealistic",
                    [RenderingStyle.SCHEMATIC]: "Technical blueprint",
                    [RenderingStyle.CONVEX_3D]: "3D embossed relief",
                    [RenderingStyle.REALISM]: "Photographic"
                };
                return styles[style] || "";
            };

            let prompt = "";

            if (config.mode === AppMode.SIGIL) {
                const thicknessDesc = config.lineThickness < 2 ? "thin lines" : config.lineThickness < 3.5 ? "medium lines" : "bold lines";
                const glowDesc = config.glowIntensity < 30 ? "subtle glow" : config.glowIntensity < 60 ? "moderate glow" : "intense glow";

                prompt = `Create a mystical collectible card (square 1:1 format).
Central symbol: ${config.visualTz}
Style: ${getStyleDescription(config.renderingStyle)}
Line treatment: ${thicknessDesc}
Energy: ${glowDesc} with ${config.auraColor} aura
Background: dark mystical atmosphere
Frame: ornate collector's card border
${config.showInscription ? 'Engraved text: ' + config.symbolName.toUpperCase() : 'No text'}
High quality, 8k resolution, dramatic lighting`;
            } else {
                prompt = `Create conceptual art representing: "${config.conceptWord}"
Style: ${getStyleDescription(config.renderingStyle)}
Square format (1:1)
Poetic, minimalist, powerful visual metaphor
Dark atmospheric background
High quality, professional composition`;
            }

            console.log('üîß –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–æ–º–ø—Ç–æ–º:', prompt);

            // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ú–û–î–ï–õ–¨ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô!
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instances: [{
                        prompt: prompt
                    }],
                    parameters: {
                        sampleCount: 1,
                        aspectRatio: "1:1",
                        safetyFilterLevel: "block_some",
                        personGeneration: "allow_adult"
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
                throw new Error(error.error?.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
            }

            const data = await response.json();
            console.log('‚úÖ –û—Ç–≤–µ—Ç API:', data);

            // Imagen –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ predictions[0].bytesBase64Encoded
            if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                return { imageUrl: `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}` };
            }

            throw new Error("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ");
        };

        // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û API –ö–õ–Æ–ß–ê
        const ApiKeyModal = ({ onSubmit }) => {
            const [key, setKey] = useState('');

            return React.createElement('div', { className: "modal" },
                React.createElement('div', { className: "modal-content" },
                    React.createElement('h2', { style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '16px' } }, 'üîë Gemini API Key'),
                    React.createElement('p', { style: { fontSize: '14px', color: '#888', marginBottom: '8px' } }, 
                        '–ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞:'
                    ),
                    React.createElement('a', { 
                        href: 'https://aistudio.google.com/apikey', 
                        target: '_blank',
                        style: { color: '#667eea', fontSize: '14px', textDecoration: 'underline' }
                    }, 'https://aistudio.google.com/apikey'),
                    React.createElement('input', {
                        type: 'text',
                        placeholder: '–í—Å—Ç–∞–≤—å —Å–≤–æ–π API –∫–ª—é—á...',
                        value: key,
                        onChange: (e) => setKey(e.target.value)
                    }),
                    React.createElement('button', {
                        onClick: () => {
                            if (key.trim()) {
                                window.setApiKey(key.trim());
                                onSubmit();
                            }
                        }
                    }, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å')
                )
            );
        };

        // –ö–û–ú–ü–û–ù–ï–ù–¢ –ü–ê–ù–ï–õ–ò (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞)
        const ControlPanel = ({ config, onChange, onGenerate, isGenerating }) => {
            const handleChange = (key, value) => onChange({ ...config, [key]: value });

            const onSymbolSelect = (e) => {
                const id = parseInt(e.target.value);
                const template = SIGIL_DATABASE.find(s => s.id === id);
                if (template) {
                    onChange({
                        ...config,
                        selectedSymbolId: id,
                        symbolName: template.nameRu,
                        visualTz: template.visualTz,
                        auraColor: template.baseColor
                    });
                }
            };

            return React.createElement('div', { className: "h-full flex flex-col bg-[#0a0a0a]" },
                React.createElement('div', { className: "flex items-center gap-4 p-8 border-b border-white/5" },
                    React.createElement('div', { className: "w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center" },
                        React.createElement('i', { className: "fa-solid fa-wand-magic-sparkles text-white text-xl" })
                    ),
                    React.createElement('div', null,
                        React.createElement('h1', { className: "text-xl font-black text-white uppercase italic" }, "Sigil Craft")
                    )
                ),

                React.createElement('div', { className: "flex-1 overflow-y-auto p-8 space-y-6" },
                    React.createElement('div', { className: "flex gap-2 p-1.5 bg-white/5 rounded-2xl" },
                        React.createElement('button', {
                            onClick: () => handleChange('mode', AppMode.SIGIL),
                            className: `flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl ${config.mode === AppMode.SIGIL ? 'bg-indigo-600 text-white' : 'text-gray-500'}`
                        }, "–°–∏–≥–∏–ª—ã"),
                        React.createElement('button', {
                            onClick: () => handleChange('mode', AppMode.ASSOCIATION),
                            className: `flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl ${config.mode === AppMode.ASSOCIATION ? 'bg-indigo-600 text-white' : 'text-gray-500'}`
                        }, "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏")
                    ),

                    config.mode === AppMode.SIGIL ? React.createElement('div', { className: "space-y-4" },
                        React.createElement('select', {
                            value: config.selectedSymbolId,
                            onChange: onSymbolSelect,
                            className: "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white"
                        }, SIGIL_DATABASE.map(s => React.createElement('option', { key: s.id, value: s.id }, `#${s.id} ‚Äî ${s.nameRu}`))),

                        React.createElement('div', null,
                            React.createElement('div', { className: "text-xs text-gray-500 mb-2" }, `–¢–æ–ª—â–∏–Ω–∞: ${config.lineThickness.toFixed(1)}px`),
                            React.createElement('input', {
                                type: "range",
                                min: "1.0",
                                max: "5.0",
                                step: "0.1",
                                value: config.lineThickness,
                                onChange: (e) => handleChange('lineThickness', parseFloat(e.target.value)),
                                className: "w-full accent-indigo-500"
                            })
                        ),

                        React.createElement('div', null,
                            React.createElement('div', { className: "text-xs text-gray-500 mb-2" }, `–ú–∞—Å—à—Ç–∞–±: ${config.symbolSize}%`),
                            React.createElement('input', {
                                type: "range",
                                min: "20",
                                max: "90",
                                value: config.symbolSize,
                                onChange: (e) => handleChange('symbolSize', parseInt(e.target.value)),
                                className: "w-full accent-indigo-500"
                            })
                        )
                    ) : React.createElement('textarea', {
                        value: config.conceptWord,
                        onChange: (e) => handleChange('conceptWord', e.target.value),
                        placeholder: "–û–ø–∏—à–∏—Ç–µ –∏–¥–µ—é...",
                        className: "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white min-h-[100px]"
                    }),

                    React.createElement('select', {
                        value: config.renderingStyle,
                        onChange: (e) => handleChange('renderingStyle', e.target.value),
                        className: "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white"
                    }, Object.values(RenderingStyle).map(v => React.createElement('option', { key: v, value: v }, v)))
                ),

                React.createElement('div', { className: "p-8 border-t border-white/5" },
                    React.createElement('button', {
                        onClick: onGenerate,
                        disabled: isGenerating,
                        className: `w-full py-5 rounded-2xl font-black text-sm uppercase ${isGenerating ? 'bg-neutral-800 text-gray-600' : 'bg-white text-black'}`
                    }, isGenerating ? '–°–∏–Ω—Ç–µ–∑–∏—Ä—É—é...' : '–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å')
                )
            );
        };

        // –ì–õ–ê–í–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢
        const FIRST_SYMBOL = SIGIL_DATABASE[0];
        const App = () => {
            const [config, setConfig] = useState({
                mode: AppMode.SIGIL,
                renderingStyle: RenderingStyle.CONVEX_3D,
                magicVibe: MagicVibe.GLOWING,
                showBorder: true,
                showInscription: false,
                selectedSymbolId: FIRST_SYMBOL.id,
                symbolName: FIRST_SYMBOL.nameRu,
                visualTz: FIRST_SYMBOL.visualTz,
                auraColor: FIRST_SYMBOL.baseColor,
                lineThickness: 2.0,
                glowIntensity: 20,
                symbolSize: 55,
                position: SymbolPosition.CENTER,
                conceptWord: ''
            });
            const [result, setResult] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [error, setError] = useState(null);
            const [showApiKeyModal, setShowApiKeyModal] = useState(!window.getApiKey());

            const handleGenerate = async () => {
                const apiKey = window.getApiKey();
                if (!apiKey) {
                    setShowApiKeyModal(true);
                    return;
                }

                setIsGenerating(true);
                setError(null);
                try {
                    const res = await generateCardImage(config, apiKey);
                    setResult(res);
                    if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } catch (err) {
                    setError(err.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
                    if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                } finally {
                    setIsGenerating(false);
                }
            };

            return React.createElement('div', null,
                showApiKeyModal && React.createElement(ApiKeyModal, { onSubmit: () => setShowApiKeyModal(false) }),

                React.createElement('div', { className: "flex flex-col md:flex-row h-screen w-full bg-[#050505] overflow-hidden" },
                    React.createElement('aside', { className: "w-full md:w-[400px] h-[50vh] md:h-full bg-[#0a0a0a] overflow-hidden" },
                        React.createElement(ControlPanel, { config, onChange: setConfig, onGenerate: handleGenerate, isGenerating })
                    ),

                    React.createElement('main', { className: "flex-1 flex items-center justify-center p-12" },
                        React.createElement('div', { className: "w-full max-w-[500px] aspect-square rounded-3xl overflow-hidden bg-black border border-white/10" },
                            isGenerating ? React.createElement('div', { className: "h-full flex flex-col items-center justify-center" },
                                React.createElement('div', { className: "w-32 h-32 mb-8" },
                                    React.createElement('svg', { className: "w-full h-full animate-spin", viewBox: "0 0 100 100" },
                                        React.createElement('circle', { cx: "50", cy: "50", r: "45", fill: "none", stroke: "currentColor", strokeWidth: "3", className: "text-indigo-500", strokeDasharray: "60 180", strokeLinecap: "round" })
                                    )
                                ),
                                React.createElement('div', { className: "text-sm text-indigo-400 font-black uppercase animate-pulse" }, "–°–∏–Ω—Ç–µ–∑...")
                            ) : result ? React.createElement('img', { src: result.imageUrl, className: "w-full h-full object-cover" }) : React.createElement('div', { className: "h-full flex flex-col items-center justify-center opacity-20" },
                                React.createElement('i', { className: "fa-solid fa-fingerprint text-7xl text-gray-700 mb-8" }),
                                React.createElement('h3', { className: "text-2xl font-black text-white/50 uppercase" }, "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
                            ),

                            error && React.createElement('div', { className: "absolute inset-0 bg-red-950/20 backdrop-blur-xl flex items-center justify-center p-12" },
                                React.createElement('div', { className: "bg-black/90 border border-red-500/30 p-10 rounded-3xl text-center max-w-sm" },
                                    React.createElement('i', { className: "fa-solid fa-triangle-exclamation text-red-500 text-3xl mb-4" }),
                                    React.createElement('p', { className: "text-white text-sm mb-6" }, error),
                                    React.createElement('button', {
                                        onClick: () => setError(null),
                                        className: "px-8 py-3 bg-white text-black text-xs font-black uppercase rounded-full"
                                    }, "–°–±—Ä–æ—Å")
                                )
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!');
    </script>
</body>
</html>
