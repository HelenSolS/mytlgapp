
import React from 'react';
import { 
  CardConfig, 
  ElementType, 
  BackgroundPreset, 
  SIGIL_DATABASE,
  StrokeStyle,
  RenderingStyle,
  MagicVibe,
  AppMode,
  SymbolPosition
} from '../types';

interface ControlPanelProps {
  config: CardConfig;
  onChange: (config: CardConfig) => void;
  onGenerate: () => void;
  isGenerating: boolean;
}

const ControlPanel: React.FC<ControlPanelProps> = ({ config, onChange, onGenerate, isGenerating }) => {
  const handleChange = (key: keyof CardConfig, value: any) => {
    onChange({ ...config, [key]: value });
  };

  const onSymbolSelect = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const id = parseInt(e.target.value);
    const template = SIGIL_DATABASE.find(s => s.id === id);
    if (template) {
      onChange({
        ...config,
        selectedSymbolId: id,
        symbolNumber: `#${id.toString().padStart(3, '0')}`,
        symbolName: template.nameRu,
        element: template.element,
        visualTz: template.visualTz,
        auraColor: template.baseColor
      });
    }
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => handleChange('referenceImage', reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const labelClass = "text-[9px] font-black text-gray-500 uppercase tracking-widest mb-3 flex justify-between items-center";
  const inputBg = "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-[12px] text-white focus:outline-none focus:border-indigo-500/50 transition-all";
  
  return (
    <div className="h-full flex flex-col bg-[#0a0a0a]">
      {/* Header Logo */}
      <div className="flex items-center gap-4 p-8 border-b border-white/5">
        <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
          <i className="fa-solid fa-wand-magic-sparkles text-white text-xl"></i>
        </div>
        <div>
          <h1 className="text-xl font-black text-white uppercase italic leading-none mb-1">Sigil Craft</h1>
          <p className="text-[9px] text-gray-600 font-bold uppercase tracking-widest">Collector Studio PRO</p>
        </div>
      </div>

      {/* Control Content */}
      <div className="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-8">
        {/* App Mode Switcher */}
        <div className="flex gap-2 p-1.5 bg-white/5 rounded-2xl border border-white/5">
          <button 
            onClick={() => handleChange('mode', AppMode.SIGIL)} 
            className={`flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl transition-all ${config.mode === AppMode.SIGIL ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}
          >
            Сигилы
          </button>
          <button 
            onClick={() => handleChange('mode', AppMode.ASSOCIATION)} 
            className={`flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl transition-all ${config.mode === AppMode.ASSOCIATION ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}
          >
            Ассоциации
          </button>
        </div>

        {config.mode === AppMode.SIGIL ? (
          <section className="space-y-6">
            <div>
              <div className={labelClass}>Выбор базового знака</div>
              <div className="relative">
                <select value={config.selectedSymbolId} onChange={onSymbolSelect} className={`${inputBg} appearance-none pr-10`}>
                  {SIGIL_DATABASE.map(s => <option key={s.id} value={s.id}>#{s.id.toString().padStart(3, '0')} — {s.nameRu}</option>)}
                </select>
                <i className="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-600 pointer-events-none"></i>
              </div>
            </div>

            <div>
              <div className={labelClass}>
                <span>Толщина линий</span>
                <span className="text-indigo-400 font-mono text-[8px]">{config.lineThickness.toFixed(1)}px</span>
              </div>
              <input 
                type="range" min="1.0" max="5.0" step="0.1" value={config.lineThickness} 
                onChange={(e) => handleChange('lineThickness', parseFloat(e.target.value))}
                className="w-full accent-indigo-500 h-1 bg-white/10 rounded-full appearance-none cursor-pointer"
              />
            </div>
          </section>
        ) : (
          <section className="space-y-6 animate-fadeIn">
            <div>
              <div className={labelClass}>Концептуальный запрос</div>
              <textarea 
                value={config.conceptWord}
                onChange={(e) => handleChange('conceptWord', e.target.value)}
                placeholder="Опишите идею для визуализации..."
                className={`${inputBg} min-h-[100px] resize-none focus:ring-2 ring-indigo-500/20`}
              />
            </div>
          </section>
        )}

        {/* Universal Settings */}
        <section className="space-y-6 border-t border-white/5 pt-8">
          <div>
            <div className={labelClass}>Художественный стиль</div>
            <div className="relative">
              <select value={config.renderingStyle} onChange={(e) => handleChange('renderingStyle', e.target.value)} className={`${inputBg} appearance-none pr-10`}>
                {Object.values(RenderingStyle).map(v => <option key={v} value={v}>{v}</option>)}
              </select>
              <i className="fa-solid fa-palette absolute right-4 top-4 text-gray-600 pointer-events-none"></i>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <div className={labelClass}>Режим цвета</div>
              <div className="flex p-1 bg-white/5 rounded-xl border border-white/5">
                <button onClick={() => handleChange('isMonochrome', false)} className={`flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all ${!config.isMonochrome ? 'bg-indigo-600 text-white' : 'text-gray-500'}`}>Full</button>
                <button onClick={() => handleChange('isMonochrome', true)} className={`flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all ${config.isMonochrome ? 'bg-white text-black' : 'text-gray-500'}`}>B&W</button>
              </div>
            </div>
            <div>
              <div className={labelClass}>Энергия</div>
              <select value={config.magicVibe} onChange={(e) => handleChange('magicVibe', e.target.value)} className={`${inputBg} appearance-none !py-2`}>
                {Object.values(MagicVibe).map(v => <option key={v} value={v}>{v}</option>)}
              </select>
            </div>
          </div>

          {!config.isMonochrome && (
            <div className="p-4 bg-white/5 rounded-2xl border border-white/5 flex items-center gap-4 transition-all">
              <input type="color" value={config.auraColor} onChange={(e) => handleChange('auraColor', e.target.value)} className="w-10 h-10 bg-transparent border-none rounded-lg cursor-pointer transition-transform hover:scale-110" />
              <div>
                <div className="text-[10px] font-mono text-gray-400 uppercase leading-none">{config.auraColor}</div>
                <div className="text-[8px] text-gray-600 font-bold uppercase mt-1 tracking-widest">Цвет основной ауры</div>
              </div>
            </div>
          )}
        </section>

        {/* Visual Refinement */}
        <section className="space-y-6 border-t border-white/5 pt-8">
          <div>
            <div className={labelClass}>
              <span>Масштаб объекта</span>
              <span className="text-indigo-400 font-mono text-[8px]">{config.symbolSize}%</span>
            </div>
            <input 
              type="range" min="20" max="90" value={config.symbolSize} 
              onChange={(e) => handleChange('symbolSize', parseInt(e.target.value))}
              className="w-full accent-indigo-500 h-1 bg-white/10 rounded-full appearance-none cursor-pointer"
            />
          </div>

          <div>
             <div className={labelClass}>Референс или набросок</div>
             {config.referenceImage ? (
               <div className="relative rounded-2xl overflow-hidden border border-white/10 aspect-video bg-black/40 group">
                 <img src={config.referenceImage} className="w-full h-full object-contain p-2" />
                 <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <button onClick={() => handleChange('referenceImage', undefined)} className="bg-red-600 p-3 rounded-full hover:scale-110 transition-transform shadow-lg">
                      <i className="fa-solid fa-trash text-white"></i>
                    </button>
                 </div>
               </div>
             ) : (
               <label className="flex flex-col items-center justify-center w-full py-8 border-2 border-dashed border-white/5 rounded-2xl cursor-pointer hover:border-indigo-500/50 hover:bg-white/[0.02] transition-all group">
                 <i className="fa-solid fa-cloud-arrow-up text-gray-700 text-2xl mb-2 group-hover:text-indigo-500 transition-colors"></i>
                 <span className="text-[9px] text-gray-600 uppercase font-black tracking-widest">Загрузить эскиз</span>
                 <input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} />
               </label>
             )}
          </div>
        </section>

        {/* Technical Toggles */}
        <section className="grid grid-cols-2 gap-4 pb-4">
           <label className="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/[0.08] transition-all">
              <span className="text-[9px] font-black uppercase text-gray-500 tracking-widest">Рамка</span>
              <input type="checkbox" checked={config.showBorder} onChange={(e) => handleChange('showBorder', e.target.checked)} className="w-4 h-4 accent-indigo-500 rounded border-none focus:ring-0" />
            </label>
            <label className="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/[0.08] transition-all">
              <span className="text-[9px] font-black uppercase text-gray-500 tracking-widest">Текст</span>
              <input type="checkbox" checked={config.showInscription} onChange={(e) => handleChange('showInscription', e.target.checked)} className="w-4 h-4 accent-indigo-500 rounded border-none focus:ring-0" />
            </label>
        </section>
      </div>

      {/* Synthesis Button */}
      <div className="p-8 bg-[#0a0a0a] border-t border-white/5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        <button 
          onClick={onGenerate} 
          disabled={isGenerating || (config.mode === AppMode.ASSOCIATION && !config.conceptWord.trim())} 
          className={`w-full py-5 rounded-2xl font-black text-[12px] tracking-[0.3em] flex items-center justify-center gap-4 transition-all uppercase shadow-2xl ${isGenerating ? 'bg-neutral-800 text-gray-600' : 'bg-white text-black hover:scale-[1.02] active:scale-[0.98]'}`}
        >
          {isGenerating ? <i className="fa-solid fa-atom fa-spin text-indigo-500"></i> : <i className="fa-solid fa-bolt"></i>}
          <span>{isGenerating ? 'Синтезирую...' : 'Синтезировать'}</span>
        </button>
      </div>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
      `}</style>
    </div>
  );
};

export default ControlPanel;
